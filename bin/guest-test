#!/bin/bash
#
# Copyright (C) 2012  Eric Schulte
#
# Usage: guest-test program variant
# build and run VARIANT of PROGRAM returning graphite output
#
. $(dirname $0)/common
. /home/bacon/.profile
. /home/bacon/.bashrc

LIMIT="/home/bacon/bin/limit"
LOCK="/tmp/lockfile"
quit_locked(){ echo busy; exit  1; }
quit_free(){ rm -f $LOCK; exit $1; }

# atomic check and set on the VM lock
(umask 222; echo $$ >$LOCK) 2>/dev/null || quit_locked;

PROGRAM=$1
VARIANT=$2
if [ -z "$1" ];then help; fi
pushd /home/bacon/benchmark/$PROGRAM >/dev/null 2>/dev/null
case $PROGRAM in
    blackscholes)
        RUNDIR=~/graphite/tests/parsec/pkgs/apps/blackscholes/run
        (mv $VARIANT blackscholes.c && make clean && make) >/dev/null 2>/dev/null
        RESULTS="$($LIMIT /home/bacon/bin/graphite-run ./blackscholes 4 $RUNDIR/in_4.txt $RUNDIR/prices.txt 2>/dev/null)"
        RETURN=$?
        ;;
    *)
        echo "$0: '$PROGRAM' is not a recognized program" >&2;
        quit_free 1
        ;;
esac
echo "$RESULTS"
quit_free $RETURN
