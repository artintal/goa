#!/bin/bash
#
# Copyright (C) 2012  Eric Schulte
#
# Usage: guest-test program rep variant
# build and run VARIANT of REP representation of PROGRAM
# return graphite output
#
. $(dirname $0)/common
. /home/bacon/.profile
. /home/bacon/.bashrc

THREADS=8
INPUT="/home/bacon/input"
LIMIT="/home/bacon/bin/limit"
LOCK="/tmp/lockfile"
quit_locked(){ echo busy; exit  1; }
quit_free(){ rm -f $LOCK; exit $1; }
g_run(){ $LIMIT /home/bacon/bin/graphite-run $@ 2>/dev/null; }

# atomic check and set on the VM lock
(umask 222; echo $$ >$LOCK) 2>/dev/null || quit_locked;

PROGRAM=$1
REP=$2
VARIANT=$3
if [ -z "$1" ];then help; fi

BS_LFLAGS=''
BS_LFLAGS+='-L/usr/lib64 -L/usr/lib -static -u CarbonStartSim -u CarbonStopSim '
BS_LFLAGS+='-L/home/bacon/graphite/lib '
BS_LFLAGS+='-L/home/bacon/graphite/os-services-25032-gcc.4.0.0-linux-ia32_intel64/intel64 '
BS_LFLAGS+='-L/home/bacon/graphite/contrib/orion '
BS_LFLAGS+='-pthread -lcarbon_sim -lorion -los-services '
BS_LFLAGS+='-lboost_filesystem-gcc42-mt-1_35 -lboost_system-gcc42-mt-1_35 '
BS_LFLAGS+='-pthread -lstdc++ -lm'

exe=$(mktemp)
case $PROGRAM in

    blackscholes)
        RUNDIR=
        case $REP in
            # cd ~/graphite/tests/parsec/pkgs/apps/blackscholes/run
            # (cp $VARIANT blackscholes.c && make clean && make)
            CIL|CLANG|cil|clang)
                echo "CIL/CLANG blackscholes is broke" >&2; exit 1 ;;
            ASM|asm)
                (gcc $VARIANT $BS_LFLAGS -o $exe) ;;
        esac >/dev/null 2>/dev/null
        if [ $? -eq 0 ];then
                RESULTS="$(g_run $exe $THREADS $INPUT /dev/null)"
                RETURN=$?
        else
            RESULTS="compile-failure"
            RETURN=1
        fi
        rm -f $exe;;

    sort)
        pushd ~/graphite/tests/apps/sort > /dev/null
        case $REP in
            CIL|CLANG) (cp $VARIANT sort.c && make);;
            ASM)       echo "ASM rep not supported for a sorter">&2; exit 1;;
        esac >/dev/null 2>/dev/null
        RETURN=$?
        if [ $RETURN -eq 0 ];then
            RESULTS=$(cat ~/graphite/output_files/sim.out)
        else
            RESULTS=""
        fi;;
    
    *) error "'$PROGRAM' is not a recognized program";;
esac
echo "$RESULTS"
quit_free $RETURN
