#!/bin/bash
#
# Copyright (C) 2012  Eric Schulte
#
# Usage: guest-test program rep variant
# build and run VARIANT of REP representation of PROGRAM
# return graphite output
#
BASE=$(dirname $0)
. ${BASE}/common
. /home/bacon/.profile
. /home/bacon/.bashrc

THREADS=4
INPUT="/home/bacon/input"
LIMIT="/home/bacon/bin/easy-limit"
LOCK="/tmp/lockfile"
EXE=$(mktemp)
quit_locked(){ echo busy; exit  1; }
quit_free(){ rm -f $LOCK; rm -f $EXE; rm -f $VARIANT; rm -rf /tmp/*; exit $1; }
g_run(){ $LIMIT /home/bacon/bin/graphite-run $@ 2>/dev/null; }
b_test(){ $LIMIT ${BASE}/blackscholes-test $1; }

# atomic check and set on the VM lock
(umask 222; echo $$ >$LOCK) 2>/dev/null || quit_locked;

PROGRAM=$1
REP=$2
VARIANT=$3
if [ -z "$1" ];then help; fi

BS_LFLAGS=''
BS_LFLAGS+='-L/usr/lib64 -L/usr/lib '
BS_LFLAGS+='-L/home/bacon/graphite/tests/parsec/pkgs/libs/hooks/inst/amd64-linux.graphite/lib '
BS_LFLAGS+='-static '
BS_LFLAGS+='-u CarbonStartSim -u CarbonStopSim -u pthread_create -u pthread_join '
BS_LFLAGS+='-L/home/bacon/graphite/lib '
BS_LFLAGS+='-L/home/bacon/graphite/contrib/dsent '
BS_LFLAGS+='-lhooks -lcarbon_sim -ldsent_contrib '
BS_LFLAGS+='-lboost_filesystem-mt -lboost_system-mt -lpthread -lstdc++ -lm'

X264_LFLAGS=''
X264_LFLAGS+='-D_GNUCC x264/libx264-asm.a '
X264_LFLAGS+='-L/usr/lib32 -L/usr/lib -static '
X264_LFLAGS+='-u CarbonStartSim -u CarbonStopSim '
X264_LFLAGS+='-L/home/bacon/graphite/lib '
X264_LFLAGS+='-L/home/bacon/graphite/os-services-25032-gcc.4.0.0-linux-ia32_intel64/intel64 '
X264_LFLAGS+='-L/home/bacon/graphite/contrib/orion '
X264_LFLAGS+='-pthread -lcarbon_sim -lorion -los-services '
X264_LFLAGS+='-lboost_filesystem-gcc42-mt-1_35 '
X264_LFLAGS+='-lboost_system-gcc42-mt-1_35 '
X264_LFLAGS+='-pthread -lstdc++ '
X264_LFLAGS+='-lm '
X264_LFLAGS+='-L/usr/lib32 -L/usr/lib -static '
X264_LFLAGS+='-u CarbonStartSim -u CarbonStopSim '
X264_LFLAGS+='-L/home/bacon/graphite/lib '
X264_LFLAGS+='-L/home/bacon/graphite/os-services-25032-gcc.4.0.0-linux-ia32_intel64/intel64 '
X264_LFLAGS+='-L/home/bacon/graphite/contrib/orion '
X264_LFLAGS+='-pthread -lcarbon_sim -lorion -los-services '
X264_LFLAGS+='-lboost_filesystem-gcc42-mt-1_35 '
X264_LFLAGS+='-lboost_system-gcc42-mt-1_35 '
X264_LFLAGS+='-pthread -lstdc++ -lm  -lm -lpthread -s'

case $PROGRAM in

    blackscholes)
        case $REP in
            ASM|asm) (gcc $VARIANT $BS_LFLAGS -o $EXE) ;;
            *) echo "$REP not supported with $PROGRAM!">&2; quit_free 1 ;;
        esac >/dev/null 2>/dev/null
        if [ $? -eq 0 ];then
            RESULT="$(b_test $EXE)"
            if [ $RESULT -eq 5 ];then
                RESULTS="$(g_run $EXE $THREADS $INPUT /dev/null)"
                RETURN=$?
            else
                RESULTS="test-failure"
                RETURN=1
            fi
        else
            RESULTS="compile-failure"
            RETURN=1
        fi;;

    x264)
        THREADS=1
        case $REP in
            CIL|cil)
                echo "gcc $VARIANT $X264_LFLAGS -o $EXE";
                (gcc $VARIANT $X264_LFLAGS -o $EXE) ;;
            *) echo "$REP not supported with $PROGRAM!">&2; quit_free 1 ;;
        esac
        if [ $? -eq 0 ];then
            RESULTS="$(g_run $EXE $THREADS $INPUT /dev/null)"
            RETURN=$?
        else
            RESULTS="compile-failure"
            RETURN=1
        fi;;

    sort)
        pushd ~/graphite/tests/apps/sort > /dev/null
        case $REP in
            CIL|CLANG) (cp $VARIANT sort.c && make);;
            ASM) echo "ASM rep not supported for a sorter">&2; quit_free 1;;
        esac >/dev/null 2>/dev/null
        RETURN=$?
        if [ $RETURN -eq 0 ];then
            RESULTS=$(cat ~/graphite/output_files/sim.out)
        else
            RESULTS=""
        fi;;

    *) error "'$PROGRAM' is not a recognized program";;
esac
echo "$RESULTS"
quit_free $RETURN
