#!/bin/bash
#
# Copyright (C) 2012  Eric Schulte
#
# Usage: guest-test program rep variant
# build and run VARIANT of REP representation of PROGRAM
# return graphite output
#
. $(dirname $0)/common
. /home/bacon/.profile
. /home/bacon/.bashrc

LIMIT="/home/bacon/bin/limit"
LOCK="/tmp/lockfile"
quit_locked(){ echo busy; exit  1; }
quit_free(){ rm -f $LOCK; exit $1; }
g_run(){ $LIMIT /home/bacon/bin/graphite-run $@ 2>/dev/null; }

# atomic check and set on the VM lock
(umask 222; echo $$ >$LOCK) 2>/dev/null || quit_locked;

PROGRAM=$1
REP=$2
VARIANT=$3
if [ -z "$1" ];then help; fi
pushd /home/bacon/benchmark/$PROGRAM >/dev/null 2>/dev/null
case $PROGRAM in

    blackscholes)
        RUNDIR=~/graphite/tests/parsec/pkgs/apps/blackscholes/run
        case $REP in
            CIL|CLANG) (cp $VARIANT blackscholes.c && make clean && make);;
            ASM)       (cp $VARIANT blackscholes.s && make clean && make);;
        esac >/dev/null 2>/dev/null ;;
    if [ $? -eq 0 ];then
        RESULTS="$(g_run ./blackscholes 4 $RUNDIR/in_4.txt $RUNDIR/prices.txt)"
        RETURN=$?
    else
        RESULTS="compile-failure"
        RETURN=1
    fi

    *) error "'$PROGRAM' is not a recognized program";;
esac
echo "$RESULTS"
quit_free $RETURN
