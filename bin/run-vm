#!/bin/bash
#
# Usage: run-vm [disk] [port]
# run a virtual machine with ssh access to a port
#
# disk      image or overlay to use
#           (defaults to tune.qcow)
#
# port      port on which to listen for ssh connections
#           (2222)
#
. $(dirname $0)/common

HDA="$1"
PORT="$2"

if [ -z "$1" ];then DISK="$DEFAULT_DISK";
               else DISK="$1"; fi

if [ -z "$2" ];then PORT=2222
               else PORT=$2; fi

# quit if overlay is already running
ps auxwww|grep "\-hda $DISK"|grep -v "grep" >/dev/null && \
    echo "overlay is already running" && exit 1

# run
$QEMU_CMD -hda $HDA -m 8G -smp 2 \
    -net nic -net user,hostfwd=tcp:127.0.0.1:$PORT-:22 \
    $QEMU_FLAGS
