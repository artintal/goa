#!/bin/bash
#
# Usage: host-test program variant
#
# Commentary:
#   does not follow the normal test script format, rather it;
#    1. takes the path to a .s asm file
#    2. copies that file to a VM
#    3. runs the resulting program in Graphite in the VM
#    4. returns the full set of Graphite debug info as lisp
#
. $(dirname $0)/common

if [ -z "$2" ];then help; exit 1;fi
program=$1
var=$2
guest_test="/home/bacon/bin/guest-test"
cmd="$guest_test $program /tmp/$(basename $var)"
output_path="graphite/output_files/sim.out"

first_few(){
    local orig="$1";
    echo "$orig"|head -1|cut -c1-4
}

## run remotely and collect output and return value
output="busy"
err=""
remote=$(my_remote)
while [ "$(first_few $output)" == "busy" ]; do
    echo -e "\tchecking ${remote}" >&2
    vm_scp $remote $var bacon@localhost:/tmp/ >/dev/null 2>/dev/null
    output=$(vm_ssh  $remote -t bacon@localhost "$cmd" 2>/dev/null)
    err=$?
    if [ "$output" == "busy" ];then sleep 0.125; fi
    remote=$(rand_remote)
done
echo -e "\texecuted ${remote}" >&2

# post process
sed_cmd=$(cat <<EOF
s/\[spawn.py\] //;
s/://;
s/start time/start/;
s/stop time/stop/;
s/shutdown time/shutdown/;
s/\([a-z]\) \([a-z]\)/\1-\2/g;
s/|//g;
s/^ \+//;
s/([^)]\+)//g;
s/tile /tile-/g;
s/^(parsec/parsec/;
s/	/ /g;
s/ \+/ /g;
EOF
)
echo "$output"|sed '/Starting process/d;/Simulation timers/d' \
    |tr [A-Z] [a-z] \
    |sed "$sed_cmd"
exit $err
