#!/bin/bash
#
# Usage: best ...|multi-power BENCHMARK DIR
#  measure the power consumption of the best individuals
#
# Options:
#  -r,--repeat N -- repeat the execution N times
#  -s,-sleep N ---- sleep for N seconds between runs
# 
. $(dirname $0)/common

BENCH=$1
DIR=$2
REPEAT=20
SLEEP=10

eval set -- $(getopt -o r:s: -l repeat:,sleep: -- "$@" || help;)
while [ $# -gt 0 ];do
    case $1 in
        -r|--repeat) REPEAT=$2; shift;;
        -s|--sleep) SLEEP=$2; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

STORES=$(cat -|awk '{print $3}')
for store in $STORES;do
    echo $store
    exe=$(mktemp)
    "$BASE"/bin/objread "$DIR/$store" -l $exe && \
        sleep $SLEEP && \
        "$BASE"/bin/run $BENCH $exe -l "" -w -r $REPEAT
    rm -f $exe
    echo ""
done
