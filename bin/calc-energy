#!/bin/bash
#
# Usage: run BENCHMARK EXECUTABLE -p|calc-energy MODEL
#  calculate the energy of a run
#
# Models:
# amd ---- AMD Opteron
# intel -- Intel Sandy Bridge
#
STATS="$(cat -)"

model(){
    case $1 in
        amd)
            cat <<EOF
4.411e-14	cycles
2.235e-15	instructions
-8.531e-16	r533f00
-1.256e-14	cache-references
3.679e-13	cache-misses
EOF
            ;;
        intel) echo "no intel power model">&2;exit 1;;
    esac; }

part(){
    local coefficient=$(echo $1|sed 's/e/\*10\^/;s/+//')
    local metric="$2"
    local value="$(echo "$STATS"|grep $metric|cut -d, -f1)";
    if [ -z $value ];then
        echo "$metric not found!">&2;
        exit 1;
    fi
    echo "$coefficient * $value"|bc -l; }

ENERGY=0
MODEL=$(model $1)
if [ ! $? -eq 0 ];then exit 1; fi

IFS="
"
for line in $MODEL;do
    coefficient=$(echo "$line"|cut -f1)
    metric=$(echo "$line"|cut -f2)
    portion=$(part $coefficient $metric)
    if [ ! $? -eq 0 ];then exit 1; fi
    ENERGY=$(echo "$ENERGY + $portion"|bc -l)
done
echo $ENERGY
