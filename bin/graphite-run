#!/bin/bash
#
# graphite-run [options] program args
# Run a program with Graphite
#
# Options
# -c,--cores       specify the number of cores (default: 8)
# -t,--threads     specify the number of threads (default: 1)
#
CORES=4
THREADS=1
eval set -- $(getopt -o c:t: -l cores:,threads: -- $@)
while [ $# -gt 0 ];do
    case $1 in
        -c|--cores) CORES="$2"; shift;;
        -t|--threads) THREADS="$2"; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

# ## Old Graphite
# OUT=output_files
# /home/bacon/graphite/tools/spawn.py 1      \
#     /home/bacon/graphite/carbon_sim.cfg    \
#     /home/bacon/pin/intel64/bin/pinbin     \
#     -mt                                    \
#     -t /home/bacon/graphite/lib/pin_sim    \
#     -c /home/bacon/graphite/carbon_sim.cfg \
#     --general/total_cores=${CORES}         \
#     --general/num_processes=${THREADS}     \
#     --general/enable_shared_mem=true       \
#     -- $@

# ## New Graphite
OUT=$(mktemp -d)
/home/bacon/graphite/tools/spawn_master.py 1 \
    /home/bacon/graphite/carbon_sim.cfg      \
    /home/bacon/pin/intel64/bin/pinbin       \
    -tool_exit_timeout 1 -mt                 \
    -t /home/bacon/graphite/lib/pin_sim      \
    -c /home/bacon/graphite/carbon_sim.cfg   \
    --general/total_cores=${CORES}           \
    --general/num_processes=${THREADS}       \
    --general/enable_shared_mem=true         \
    --general/output_dir=${OUT}              \
    -- $@

## Wiki Instructions (don't work)
# export CARBON_PROCESS_INDEX=0
# ${PIN_HOME}/intel64/bin/pinbin          \
#     -mt                                 \
#     -t ${GRAPHITE_HOME}/lib/pin_sim     \
#     -c ${GRAPHITE_HOME}/carbon_sim.cfg  \
#      --general/total_cores=${CORES}     \
#      --general/num_processes=${THREADS} \
#      --general/enable_shared_mem=true   \
#      --general/output_dir=${OUT}        \
#     -- $@

RESULT=$?
cat ${OUT}/sim.out
rm -rf ${OUT}/
exit $RESULT
