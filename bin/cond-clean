#!/bin/bash
#
# Usage: cond-clean PID
#
# Conditionally clean up a remote VM's /tmp/ directory *only* if it
# doesn't have anything running.
#
# Apparently these things sometimes get polluted (e.g., leftover
# lockfiles) from failing runs.
#
REMOTE_CMD="ps auxwww |grep -v grep|grep -q graphite-run "
REMOTE_CMD+="|| [ -f /tmp/lockfile ] && ls /tmp|xargs -I{} rm -f /tmp/{}"

for pid in $@;do
  PORT=$(ps auxwww|grep $pid|grep qemu-kvm|sed 's/^.*127.0.0.1://;s/-:.*$//g')
  echo $PORT
  ssh -i data/id_rsa -p $PORT bacon@localhost $REMOTE_CMD
done
