#!/bin/bash
#
# Usage: many-multi-inputs RESULT-DIR [OPTIONS...]
#   Run multiple benchmarks for multiple input sizes
#
# Options:
#  -b,--bench B ---- limit to benchmark B
#  -s,--size S ----- limit to size S
#
. $(dirname $0)/common
outdir=$1
if [ -z "$outdir" ];then error "must specify output directory"; fi
if [ ! -d $outdir ];then
    error "output directory $outdir does not exist"
fi

eval set -- $(getopt -o b:s: -l bench:,size: -- "$@" || help;)
while [ $# -gt 0 ];do
    case $1 in
        -b|--bench) BENCHMARKS=($2); shift;;
        -s|--size) SIZES=($2); shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

run="$BASE/bin/run"

uniform(){ awk -F, '{print $2,$1}'|sort; }

for size in ${SIZES[@]};do
    for bench in ${BENCHMARKS[@]};do
        opt=benchmarks/$bench/$bench.opt
        holder=$(mktemp)
        if [ ! -f $opt ];then warning "$opt does not exist"; fi
        mv $opt $holder
        mgmt clean $bench
        mgmt output $bench -s $size
        mv $holder $opt
        echo "$bench $size"
        orig=$(mktemp)
        evol=$(mktemp)
        $run $bench benchmarks/$bench/$bench -l "" -s $size -p -k > $orig
        tmp=$(cat $orig|grep output|sed 's/^.* //')
        $run $bench $otp -l "" -s $size -o $tmp -p |tee $evol
        join <(cat $orig|grep -v output|uniform) <(cat $evol|uniform) \
            |sed 's/ /,/g' |tee $outdir/$bench-$size.csv
        rm -f $tmp $orig $evol
        echo ""
    done
done
